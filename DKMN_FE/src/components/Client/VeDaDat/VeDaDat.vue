<template>
  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="card shadow-sm">
          <div class="card-header bg-white d-flex align-items-center justify-content-between">
            <h5 class="mb-0">V√© ƒë√£ ƒë·∫∑t</h5>
            <span class="badge bg-success" v-if="ticket">Th√†nh c√¥ng</span>
          </div>

          <div class="card-body">
            <!-- ‚ö™ Khi ch∆∞a c√≥ v√© -->
            <div v-if="!ticket" class="text-center py-4">
              <div class="mb-2">Ch∆∞a c√≥ v√© n√†o ƒë∆∞·ª£c l∆∞u.</div>
              <router-link class="btn btn-primary" to="/TrangChu">ƒê·∫∑t v√© ngay</router-link>
            </div>

            <!-- üü¢ Khi c√≥ v√© -->
            <div v-else>
              <ul class="list-group list-group-flush mb-3">
                <li class="list-group-item" v-if="ticket.from || ticket.to">
                  <div class="d-flex justify-content-between">
                    <span>H√†nh tr√¨nh</span>
                    <span class="text-muted">{{ ticket.from || '-' }} ‚Üí {{ ticket.to || '-' }}</span>
                  </div>
                </li>
                <li class="list-group-item" v-if="ticket.date">
                  <div class="d-flex justify-content-between">
                    <span>Ng√†y ƒëi</span>
                    <span class="text-muted">{{ ticket.date }}</span>
                  </div>
                </li>
                <li class="list-group-item" v-if="ticket.company">
                  <div class="d-flex justify-content-between">
                    <span>Nh√† v·∫≠n h√†nh</span>
                    <span class="text-muted">{{ ticket.company }}</span>
                  </div>
                </li>
                <li class="list-group-item" v-if="ticket.pickupStation || ticket.dropoffStation">
                  <div class="d-flex justify-content-between">
                    <span>ƒêi·ªÉm ƒë√≥n</span>
                    <span class="text-muted">{{ ticket.pickupStation || '-' }}</span>
                  </div>
                  <div class="d-flex justify-content-between mt-1">
                    <span>ƒêi·ªÉm tr·∫£</span>
                    <span class="text-muted">{{ ticket.dropoffStation || '-' }}</span>
                  </div>
                </li>
                <li class="list-group-item" v-if="ticket.passengers">
                  <div class="d-flex justify-content-between">
                    <span>S·ªë h√†nh kh√°ch</span>
                    <span class="text-muted">{{ ticket.passengers }}</span>
                  </div>
                </li>
                <li class="list-group-item d-flex justify-content-between"><span>M√£ giao d·ªãch</span><strong>{{ ticket.paymentId }}</strong></li>
                <li class="list-group-item d-flex justify-content-between"><span>C·ªïng thanh to√°n</span><strong class="text-uppercase">{{ ticket.gateway }}</strong></li>
                <li class="list-group-item d-flex justify-content-between" v-if="ticket.tripId"><span>M√£ chuy·∫øn</span><strong>{{ ticket.tripId }}</strong></li>
                <li class="list-group-item" v-if="(ticket.seats||[]).length">
                  <div class="d-flex justify-content-between">
                    <span>Gh·∫ø</span>
                    <span class="text-muted">{{ ticket.seats.join(', ') }}</span>
                  </div>
                </li>
                <li class="list-group-item d-flex justify-content-between"><span>Th√†nh ti·ªÅn</span><strong>{{ formatCurrency(ticket.total) }}</strong></li>
                <li class="list-group-item d-flex justify-content-between"><span>Ng√†y gi·ªù</span><strong>{{ formatTime(ticket.createdAt) }}</strong></li>
              </ul>

              <!-- üîò C√°c n√∫t h√†nh ƒë·ªông -->
              <div class="d-flex gap-2">
                <router-link to="/TrangChu" class="btn btn-outline-secondary">V·ªÅ trang ch·ªß</router-link>
                <button class="btn btn-danger" @click="clearTicket">X√≥a v√© ƒë√£ l∆∞u</button>
                <button
                  class="btn btn-primary"
                  :disabled="!canRate"
                  v-if="ticket?.tripId"
                  @click="goRate"
                >
                  ƒê√°nh gi√°
                    </button>
                  </div>
              </div>

              <!-- ‚ö†Ô∏è Alert c·∫£nh b√°o -->
              <div
                v-if="notice.visible"
                class="alert alert-warning position-fixed bottom-0 start-0 m-3 shadow-sm d-flex align-items-center gap-2"
                role="alert"
              >
                <i class="bx bx-info-circle fs-5"></i>
                <span>{{ notice.text }}</span>
                <button
                  type="button"
                  class="btn-close ms-auto"
                  @click="notice.visible = false"
                ></button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
</template>

<script>
export default {
  name: 'VeDaDat',
  data() {
    return {
      ticket: null,
      ratingsIndex: {},
      notice: { visible: false, text: '' } // ‚ö†Ô∏è Alert hi·ªán th√¥ng b√°o
    }
  },
  computed: {
    canRate() {
      if (!this.ticket) return false;
      const status = this.ticket.tripStatus;
      const alreadyRated = this.ticket?.tripId
        ? !!this.ratingsIndex[String(this.ticket.tripId)]
        : false;
      // üîπ Ch·ªâ ƒë∆∞·ª£c ƒë√°nh gi√° khi admin ƒë√£ x√°c nh·∫≠n ho√†n th√†nh
      return status === "completed" && !alreadyRated;
    },
  },
  methods: {
    formatCurrency(value) {
      return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value || 0)
    },
    formatTime(ts) {
      try {
        const d = new Date(ts)
        return d.toLocaleString('vi-VN')
      } catch (e) {
        return ''
      }
    },
    clearTicket() {
      try { localStorage.removeItem('dkmn:lastTicket') } catch (e) {}
      this.ticket = null
    },
    loadRatingsIndex() {
      try {
        const raw = localStorage.getItem('dkmn:ratings')
        const arr = raw ? JSON.parse(raw) : []
        const idx = {}
        arr.forEach(r => { idx[String(r.tripId)] = true })
        this.ratingsIndex = idx
      } catch (e) {
        this.ratingsIndex = {}
      }
    },

    // üü¢ Admin x√°c nh·∫≠n ho√†n th√†nh v√©
    confirmByAdmin() {
      if (!this.ticket) return;
      this.ticket.tripStatus = "completed";
      localStorage.setItem("dkmn:lastTicket", JSON.stringify(this.ticket));
      this.notice.text = "‚úÖ Admin ƒë√£ x√°c nh·∫≠n chuy·∫øn ƒëi ho√†n th√†nh!";
      this.notice.visible = false;
    },

    // üü† Chuy·ªÉn ƒë·∫øn trang ƒë√°nh gi√°
    goRate() {
      if (!this.ticket?.tripId) return;

      // üîπ N·∫øu admin ch∆∞a x√°c nh·∫≠n th√¨ c·∫£nh b√°o
      if (this.ticket.tripStatus !== "completed") {
        this.notice.text = "‚ö†Ô∏è Chuy·∫øn ƒëi ch∆∞a ƒë∆∞·ª£c admin x√°c nh·∫≠n ho√†n th√†nh, b·∫°n ch∆∞a th·ªÉ ƒë√°nh gi√°!";
        this.notice.visible = true;
        return;
      }

      // ‚úÖ N·∫øu ƒë√£ ho√†n th√†nh -> cho ph√©p ƒë√°nh gi√°
      this.$router.push({
        path: '/client-danh-gia',
        query: {
          tripId: String(this.ticket.tripId || ''),
          from: this.ticket.from || '',
          to: this.ticket.to || '',
          date: this.ticket.date || ''
        }
      });
    }
  },
  mounted() {
    // L·∫•y d·ªØ li·ªáu v√© t·ª´ query ho·∫∑c localStorage
    const q = this.$route?.query || {}
    if (q && (q.paymentId || q.total)) {
      const inline = {
        paymentId: String(q.paymentId || ''),
        gateway: String(q.gateway || ''),
        total: Number(q.total || 0),
        tripId: q.tripId ? String(q.tripId) : null,
        seats: q.seats ? String(q.seats).split(',').map(s => s.trim()).filter(Boolean) : [],
        createdAt: q.createdAt ? Number(q.createdAt) : Date.now(),
        from: q.from ? String(q.from) : '',
        to: q.to ? String(q.to) : '',
        date: q.date ? String(q.date) : '',
        passengers: q.passengers ? String(q.passengers) : '',
        pickupStation: q.pickupStation ? String(q.pickupStation) : '',
        dropoffStation: q.dropoffStation ? String(q.dropoffStation) : '',
        company: q.company ? String(q.company) : '',
        tripStatus: q.tripStatus || 'pending'
      }
      this.ticket = inline
      return
    }

    try {
      const raw = localStorage.getItem('dkmn:lastTicket')
      if (raw) this.ticket = JSON.parse(raw)
    } catch (e) {
      this.ticket = null
    }

    this.loadRatingsIndex()
  }
}
</script>

<style>
.alert {
  animation: fadeIn 0.3s ease;
}
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>
